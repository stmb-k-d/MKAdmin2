{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Adsets{% endblock %}

{% block page_title %}Наборы объявлений{% endblock %}

{% block extra_head %}
<style>
    /* Основной контейнер с прокруткой */
    .table-container {
        width: 100%;
        overflow-x: auto;
        max-height: 85vh;
        overflow-y: auto;
    }
    
    /* Основные стили таблицы */
    #adsetsTable {
        font-size: 0.65rem;
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
    }
    
    /* Ячейки таблицы */
    #adsetsTable th, 
    #adsetsTable td {
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 3px;
        border: 1px solid #dee2e6;
    }
    
    /* Заголовки */
    #adsetsTable th {
        background-color: #f8f9fa;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    /* Строки */
    #adsetsTable tr:nth-child(even) {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    #adsetsTable tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    /* Выделенная строка */
    #adsetsTable tbody tr.highlighted {
        background-color: rgba(40, 167, 69, 0.15) !important;
    }
    
    /* Стили для сортировки */
    #adsetsTable th.sorting {
        cursor: pointer;
        position: relative;
    }
    
    #adsetsTable th.sorting:after {
        content: '↕';
        position: absolute;
        right: 5px;
        opacity: 0.5;
    }
    
    #adsetsTable th.sorting_asc:after {
        content: '↓';
        opacity: 1;
    }
    
    #adsetsTable th.sorting_desc:after {
        content: '↑';
        opacity: 1;
    }
    
    /* Стили для модального окна выбора колонок */
    .column-selection-modal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .column-selection-container {
        display: flex;
        flex-direction: column;
    }
    
    .column-checkbox-container {
        padding: 8px;
        margin-bottom: 5px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        display: flex;
        align-items: center;
        background-color: #f8f9fa;
    }
    
    .column-checkbox-container:hover {
        background-color: #e9ecef;
    }
    
    .column-checkbox-container .drag-handle {
        cursor: move;
        margin-right: 10px;
        color: #6c757d;
    }
    
    .column-checkbox-container .form-check {
        margin-bottom: 0;
        flex-grow: 1;
    }
    
    /* Стиль для перетаскиваемого элемента */
    .column-checkbox-container.dragging {
        opacity: 0.5;
        border: 1px dashed #0d6efd;
    }
    
    /* Кнопки управления колонками */
    .column-buttons {
        margin-left: 10px;
    }
    
    /* Стили для фильтров */
    .filter-item {
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        background-color: #f8f9fa;
        position: relative;
    }
    
    .filter-item .close-btn {
        position: absolute;
        right: 10px;
        top: 10px;
        cursor: pointer;
        color: #dc3545;
    }
    
    .filter-dropdown {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .filter-value-list {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 5px;
        margin-top: 5px;
    }
    
    .filter-value-list .form-check {
        margin-bottom: 5px;
    }
    
    /* Стили для активных фильтров */
    .active-filters-indicator {
        padding: 2px 5px;
        border-radius: 50%;
        background-color: #0d6efd;
        color: white;
        font-size: 0.75rem;
        margin-left: 5px;
        min-width: 20px;
        text-align: center;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <h5 class="mb-0 me-3">Управление наборами объявлений</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showActiveOnly" role="switch">
                <label class="form-check-label" for="showActiveOnly">Активные</label>
            </div>
        </div>
        <div class="d-flex">
            <div class="me-2">
                <button type="button" class="btn btn-outline-primary btn-sm" id="showFiltersBtn" data-bs-toggle="modal" data-bs-target="#filtersModal">
                    <i class="fas fa-filter"></i> Фильтры
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm d-none" id="resetFiltersBtn">
                    <i class="fas fa-times"></i> Сбросить фильтры
                </button>
            </div>
            <div class="column-buttons">
                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#columnSelectionModal">
                    <i class="fas fa-columns"></i> Настроить колонки
                </button>
            </div>
            <div class="ms-2">
                <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Поиск...">
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-container">
            <table id="adsetsTable" class="table table-bordered">
                <thead>
                    <tr id="tableHeader">
                        <!-- Заголовки будут добавлены динамически через JavaScript -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Строки будут добавлены динамически через JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Модальное окно для выбора колонок -->
<div class="modal fade column-selection-modal" id="columnSelectionModal" tabindex="-1" aria-labelledby="columnSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnSelectionModalLabel">Выбор отображаемых колонок</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <small>Перетащите элементы, чтобы изменить порядок колонок в таблице.</small>
                </div>
                <div class="mb-3 d-flex">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" id="selectAllColumns">
                        <label class="form-check-label" for="selectAllColumns">Выбрать все колонки</label>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="resetToDefaultColumns">Сбросить</button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="saveAsDefaultColumns">Сохранить как шаблон</button>
                    </div>
                </div>
                <div class="column-selection-container" id="columnCheckboxes">
                    <!-- Чекбоксы для колонок будут добавлены динамически через JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveColumnSelection" data-bs-dismiss="modal">Применить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для фильтров -->
<div class="modal fade" id="filtersModal" tabindex="-1" aria-labelledby="filtersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filtersModalLabel">Настройка фильтров</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <small>Добавьте фильтры по нужным колонкам для уточнения выборки данных.</small>
                </div>
                <div class="mb-3 d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="addFilterBtn">
                        <i class="fas fa-plus"></i> Добавить фильтр
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="clearAllFiltersBtn">
                        <i class="fas fa-trash"></i> Очистить все фильтры
                    </button>
                </div>
                <div id="filtersContainer">
                    <!-- Фильтры будут добавляться динамически -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="applyFiltersBtn" data-bs-dismiss="modal">Применить фильтры</button>
            </div>
        </div>
    </div>
</div>

<!-- Скрипт для выделения строк -->
<script>
function highlightRow(row, event) {
    // Проверяем, что клик не на ссылку или span внутри ячейки
    if (event.target.tagName.toLowerCase() === 'a' || 
        event.target.parentElement.tagName.toLowerCase() === 'a') {
        return;
    }
    
    // Проверяем, выделена ли уже строка
    if (row.classList.contains('highlighted')) {
        // Если строка выделена, снимаем выделение
        row.classList.remove('highlighted');
    } else {
        // Снимаем выделение со всех строк
        const rows = document.querySelectorAll('#adsetsTable tbody tr');
        rows.forEach(r => r.classList.remove('highlighted'));
        
        // Выделяем текущую строку
        row.classList.add('highlighted');
    }
}
</script>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Подготовим данные для таблицы
    const adsetsData = [];
    {% for adset in adsets %}
    adsetsData.push({
        {% for key, value in adset.items %}
        "{{ key }}": {% if value != None %}"{{ value|escapejs }}"{% else %}null{% endif %}{% if not forloop.last %},{% endif %}
        {% endfor %}
    });
    {% endfor %}
    
    // Загружаем все доступные колонки
    const allColumns = JSON.parse('{{ all_columns|escapejs }}');
    console.log("Доступные колонки:", allColumns);
    
    // Изначально выбранные колонки по умолчанию для adsets
    const initialDefaultColumns = [
        'id_acc_bd', 'adset_id', 'adset_effective_status', 'adset_status', 
        'rk_name', 'camp_name', 'adset_name', 'fb_spend', 'cpi', 
        'regs', 'cpr', 'deps', 'cps', 'income', 'bprofit', 'broi'
    ];
    
    // Получаем пользовательский шаблон колонок
    let userDefaultColumns;
    try {
        const savedDefaultJSON = localStorage.getItem('adsetsTableDefaultColumns');
        if (savedDefaultJSON) {
            userDefaultColumns = JSON.parse(savedDefaultJSON);
        } else {
            userDefaultColumns = initialDefaultColumns;
        }
    } catch (e) {
        console.error('Ошибка при загрузке шаблона колонок:', e);
        userDefaultColumns = initialDefaultColumns;
    }
    
    // Загружаем сохраненные колонки или используем шаблон
    let selectedColumns;
    try {
        const savedColumnsJSON = localStorage.getItem('adsetsTableColumns');
        if (savedColumnsJSON) {
            selectedColumns = JSON.parse(savedColumnsJSON);
            if (!selectedColumns || selectedColumns.length === 0) {
                selectedColumns = userDefaultColumns;
            }
        } else {
            selectedColumns = userDefaultColumns;
        }
    } catch (e) {
        console.error('Ошибка при загрузке сохраненных колонок:', e);
        selectedColumns = userDefaultColumns;
    }
    
    console.log("Выбранные колонки:", selectedColumns);
    
    // Переменная для хранения состояния фильтра активных объявлений
    let showActiveOnly = false;
    
    // Система фильтрации
    let activeFilters = {};
    
    // Функция для форматирования значений в ячейках
    function formatCellValue(column, value) {
        if (value === null || value === undefined || value === '') {
            return '-';
        }
        
        // Специальное форматирование для конкретных колонок adsets
        if (column === 'adset_id') {
            return '<span class="text-primary">' + value + '</span>';
        } else if (column === 'adset_effective_status') {
            let badgeClass = 'bg-secondary';
            if (value === 'ACTIVE') {
                badgeClass = 'bg-success';
            } else if (value === 'PAUSED') {
                badgeClass = 'bg-warning';
            }
            return '<span class="badge ' + badgeClass + '">' + value + '</span>';
        } else if (column.includes('date') || column.includes('update')) {
            // Форматирование дат
            try {
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return day + '.' + month + '.' + year + ' ' + hours + ':' + minutes;
                }
            } catch (e) {}
            return value;
        } else if (['fb_spend', 'cpi', 'cpr', 'cps', 'income', 'bprofit'].includes(column)) {
            // Форматирование чисел с плавающей точкой
            return parseFloat(value).toFixed(2);
        } else if (column === 'broi') {
            // Форматирование процентов
            return parseFloat(value).toFixed(2) + '%';
        } else if (['regs', 'deps'].includes(column)) {
            // Форматирование целых чисел
            return parseInt(value);
        }
        
        return value;
    }
    
    // Функция для отрисовки таблицы
    function renderTable() {
        console.log("Вызов renderTable, adsetsData:", adsetsData.length);
        
        const headerRow = $('#tableHeader');
        const tableBody = $('#tableBody');
        
        // Очищаем содержимое
        headerRow.empty();
        tableBody.empty();
        
        // Добавляем заголовки колонок
        selectedColumns.forEach(function(column) {
            const th = $('<th>')
                .addClass('sorting')
                .text(column);
            headerRow.append(th);
        });
        
        // Проверяем наличие данных
        if (!adsetsData || adsetsData.length === 0) {
            // Если данных нет, выводим сообщение
            const row = $('<tr>');
            const cell = $('<td>')
                .attr('colspan', selectedColumns.length)
                .addClass('text-center')
                .text('Нет данных для отображения');
            row.append(cell);
            tableBody.append(row);
            return;
        }
        
        // Начинаем с полного набора данных
        let filteredData = [...adsetsData]; // Создаем копию массива
        
        // Фильтруем по активности, если включено
        if (showActiveOnly) {
            filteredData = filteredData.filter(adset => adset.adset_effective_status === 'ACTIVE');
        }
        
        // Применяем пользовательские фильтры
        if (activeFilters && Object.keys(activeFilters).length > 0) {
            filteredData = filteredData.filter(adset => {
                // Проверяем соответствие всем фильтрам
                for (const column in activeFilters) {
                    const allowedValues = activeFilters[column];
                    // Если значение adset не входит в разрешенные значения фильтра, исключаем
                    if (!allowedValues.includes(adset[column])) {
                        return false;
                    }
                }
                return true;
            });
        }
        
        // Добавляем строки с данными
        filteredData.forEach(function(adset) {
            const tr = $('<tr>').attr('onclick', 'highlightRow(this, event)');
            
            selectedColumns.forEach(function(column) {
                const td = $('<td>');
                td.html(formatCellValue(column, adset[column]));
                tr.append(td);
            });
            
            tableBody.append(tr);
        });
        
        // Инициализируем сортировку
        initTableSorting();
    }
    
    // Функция для инициализации сортировки
    function initTableSorting() {
        $('#adsetsTable th').off('click').click(function() {
            const table = $(this).parents('table').eq(0);
            const index = $(this).index();
            const isAsc = !$(this).hasClass('sorting_asc');
            
            // Удаляем классы сортировки со всех заголовков
            table.find('th').removeClass('sorting_asc sorting_desc');
            
            // Добавляем класс сортировки на текущий заголовок
            $(this).addClass(isAsc ? 'sorting_asc' : 'sorting_desc');
            
            // Сортируем строки
            const rows = table.find('tbody tr').toArray().sort(function(a, b) {
                const valA = $(a).find('td').eq(index).text().trim();
                const valB = $(b).find('td').eq(index).text().trim();
                
                // Пробуем сортировать как числа
                const numA = parseFloat(valA.replace(/[^\d.-]/g, ''));
                const numB = parseFloat(valB.replace(/[^\d.-]/g, ''));
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return isAsc ? numA - numB : numB - numA;
                }
                
                return isAsc 
                    ? valA.localeCompare(valB) 
                    : valB.localeCompare(valA);
            });
            
            // Добавляем отсортированные строки
            $.each(rows, function(i, row) {
                table.children('tbody').append(row);
            });
        });
    }
    
    // Заполняем чекбоксы в модальном окне с возможностью перетаскивания
    function populateColumnCheckboxes() {
        const container = $('#columnCheckboxes');
        container.empty();
        
        // Создаем массив объектов для всех колонок
        const columnsData = allColumns.map(function(column) {
            return {
                name: column,
                selected: selectedColumns.includes(column),
                order: selectedColumns.indexOf(column) === -1 ? 9999 : selectedColumns.indexOf(column)
            };
        });
        
        // Сортируем колонки: сначала выбранные в нужном порядке, затем остальные
        columnsData.sort(function(a, b) {
            if (a.selected && !b.selected) return -1;
            if (!a.selected && b.selected) return 1;
            return a.order - b.order;
        });
        
        // Добавляем чекбоксы
        columnsData.forEach(function(columnData) {
            const div = $('<div>')
                .addClass('column-checkbox-container')
                .attr('data-column', columnData.name);
            
            // Добавляем иконку для перетаскивания
            const dragHandle = $('<span>')
                .addClass('drag-handle')
                .html('<i class="fas fa-grip-vertical"></i>');
            
            const formCheck = $('<div>').addClass('form-check');
            
            const input = $('<input>')
                .addClass('form-check-input column-checkbox')
                .attr('type', 'checkbox')
                .attr('id', 'column-' + columnData.name)
                .attr('value', columnData.name)
                .prop('checked', columnData.selected);
            
            // Добавляем обработчик изменения состояния чекбокса
            input.on('change', function() {
                // Если чекбокс отмечен, перемещаем его наверх списка
                if ($(this).prop('checked')) {
                    moveCheckboxToTop($(this).val());
                }
            });
            
            const label = $('<label>')
                .addClass('form-check-label')
                .attr('for', 'column-' + columnData.name)
                .text(columnData.name);
            
            formCheck.append(input, label);
            div.append(dragHandle, formCheck);
            container.append(div);
        });
        
        // Устанавливаем состояние чекбокса "Выбрать все"
        $('#selectAllColumns').prop('checked', allColumns.length === selectedColumns.length);
        
        // Инициализируем возможность перетаскивания
        initDragAndDrop();
    }
    
    // Функция для перемещения выбранного чекбокса вверх списка
    function moveCheckboxToTop(columnName) {
        const columnContainers = $('#columnCheckboxes .column-checkbox-container');
        const container = $('#columnCheckboxes');
        
        // Находим последний отмеченный элемент (перед первым неотмеченным)
        let lastCheckedIndex = -1;
        columnContainers.each(function(index) {
            const isChecked = $(this).find('.column-checkbox').prop('checked');
            if (!isChecked && lastCheckedIndex === -1) {
                lastCheckedIndex = index - 1;
                return false;
            }
        });
        
        // Если все элементы отмечены или нет отмеченных, используем 0 или последний индекс
        if (lastCheckedIndex === -1) {
            const allChecked = columnContainers.first().find('.column-checkbox').prop('checked');
            lastCheckedIndex = allChecked ? columnContainers.length - 1 : 0;
        }
        
        // Находим элемент для перемещения
        const elementToMove = columnContainers.filter(function() {
            return $(this).attr('data-column') === columnName;
        });
        
        // Перемещаем элемент после последнего выбранного или в начало списка
        if (lastCheckedIndex >= 0) {
            if (lastCheckedIndex >= columnContainers.length - 1) {
                // Если это последний элемент, добавляем в конец
                container.append(elementToMove);
            } else {
                // Иначе вставляем после последнего отмеченного элемента
                elementToMove.insertAfter(columnContainers.eq(lastCheckedIndex));
            }
        } else {
            // Если нет отмеченных элементов, помещаем в начало
            container.prepend(elementToMove);
        }
    }
    
    // Инициализация перетаскивания для изменения порядка колонок
    function initDragAndDrop() {
        const columnItems = document.querySelectorAll('.column-checkbox-container');
        let draggedItem = null;
        
        columnItems.forEach(function(item) {
            // Начало перетаскивания
            item.addEventListener('dragstart', function() {
                draggedItem = this;
                setTimeout(function() {
                    draggedItem.classList.add('dragging');
                }, 0);
            });
            
            // Конец перетаскивания
            item.addEventListener('dragend', function() {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            });
            
            // Разрешаем перетаскивание
            item.setAttribute('draggable', 'true');
            
            // Обработка события при нахождении над элементом
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (draggedItem === this) return;
                
                const container = document.getElementById('columnCheckboxes');
                const afterElement = getDragAfterElement(container, e.clientY);
                
                if (afterElement == null) {
                    container.appendChild(draggedItem);
                } else {
                    container.insertBefore(draggedItem, afterElement);
                }
            });
        });
        
        // Вспомогательная функция для определения позиции при перетаскивании
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.column-checkbox-container:not(.dragging)')];
            
            return draggableElements.reduce(function(closest, child) {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    }
    
    // Функция для поиска
    $('#searchInput').on("keyup", function() {
        const value = $(this).val().toLowerCase();
        $('#adsetsTable tbody tr').filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
    });
    
    // Инициализация модального окна
    $('#columnSelectionModal').on('show.bs.modal', function() {
        populateColumnCheckboxes();
    });
    
    // Обработчик для "Выбрать все"
    $('#selectAllColumns').on('change', function() {
        $('.column-checkbox').prop('checked', $(this).prop('checked'));
    });
    
    // Обработчик для кнопки "Сбросить"
    $('#resetToDefaultColumns').on('click', function() {
        // Отмечаем чекбоксы из шаблона
        $('.column-checkbox').each(function() {
            const columnName = $(this).val();
            $(this).prop('checked', userDefaultColumns.includes(columnName));
        });
        
        // Обновляем чекбокс "Выбрать все"
        $('#selectAllColumns').prop('checked', allColumns.length === userDefaultColumns.length);
        
        // Перезаполняем чекбоксы для восстановления порядка из шаблона
        populateColumnCheckboxes();
    });
    
    // Обработчик для кнопки "Сохранить как шаблон"
    $('#saveAsDefaultColumns').on('click', function() {
        const newDefaultColumns = [];
        
        // Собираем выбранные колонки в том порядке, в котором они отображаются в модальном окне
        $('#columnCheckboxes .column-checkbox-container').each(function() {
            const checkbox = $(this).find('.column-checkbox');
            if (checkbox.prop('checked')) {
                newDefaultColumns.push(checkbox.val());
            }
        });
        
        // Если ничего не выбрано, показываем сообщение и не применяем изменения
        if (newDefaultColumns.length === 0) {
            alert('Выберите хотя бы одну колонку для шаблона');
            return;
        }
        
        // Сохраняем шаблон в localStorage
        localStorage.setItem('adsetsTableDefaultColumns', JSON.stringify(newDefaultColumns));
        userDefaultColumns = newDefaultColumns;
        
        // Показываем сообщение об успешном сохранении
        alert('Шаблон колонок успешно сохранен');
    });
    
    // Сохранение выбора колонок с учетом порядка
    $('#saveColumnSelection').on('click', function() {
        const newSelectedColumns = [];
        
        // Собираем выбранные колонки в том порядке, в котором они отображаются в модальном окне
        $('#columnCheckboxes .column-checkbox-container').each(function() {
            const checkbox = $(this).find('.column-checkbox');
            if (checkbox.prop('checked')) {
                newSelectedColumns.push(checkbox.val());
            }
        });
        
        // Если ничего не выбрано, показываем сообщение и не применяем изменения
        if (newSelectedColumns.length === 0) {
            alert('Выберите хотя бы одну колонку');
            return;
        }
        
        // Сохраняем выбор в localStorage
        localStorage.setItem('adsetsTableColumns', JSON.stringify(newSelectedColumns));
        
        // Обновляем выбранные колонки и перерисовываем таблицу
        selectedColumns = newSelectedColumns;
        renderTable();
    });
    
    // Обработчик для тумблера "Активные"
    $('#showActiveOnly').on('change', function() {
        showActiveOnly = $(this).prop('checked');
        renderTable();
    });
    
    // Отрисовываем таблицу при загрузке страницы
    renderTable();
    
    // Система фильтрации - инициализация
    let uniqueValues = {};
    
    // Инициализация уникальных значений для всех колонок
    function initUniqueValues() {
        if (!uniqueValues) uniqueValues = {};
        
        allColumns.forEach(column => {
            uniqueValues[column] = new Set();
        });
        
        // Проверяем наличие данных
        if (!adsetsData || adsetsData.length === 0) {
            console.warn("Нет данных для инициализации уникальных значений");
            return;
        }
        
        // Собираем все уникальные значения для каждой колонки
        adsetsData.forEach(adset => {
            allColumns.forEach(column => {
                if (adset[column] !== null && adset[column] !== undefined) {
                    uniqueValues[column].add(adset[column]);
                }
            });
        });
        
        // Преобразуем Set в массивы и сортируем
        allColumns.forEach(column => {
            uniqueValues[column] = Array.from(uniqueValues[column]).sort();
        });
        
        console.log("Уникальные значения инициализированы");
    }
    
    // Инициализируем уникальные значения
    initUniqueValues();
    
    // Функция для добавления нового фильтра
    function addFilter(column = null, values = null) {
        const filterItem = $('<div>').addClass('filter-item');
        
        const closeBtn = $('<span>').addClass('close-btn').html('<i class="fas fa-times"></i>');
        closeBtn.on('click', function() {
            $(this).parent().remove();
        });
        
        const filterRow = $('<div>').addClass('row');
        
        // Выбор колонки
        const columnSelectCol = $('<div>').addClass('col-md-5 mb-2');
        const columnLabel = $('<label>').addClass('form-label').text('Выберите колонку');
        const columnSelect = $('<select>').addClass('form-select form-select-sm filter-column-select');
        
        // Добавляем опции для выбора колонки
        columnSelect.append($('<option>').val('').text('- Выберите колонку -'));
        
        allColumns.forEach(col => {
            const option = $('<option>').val(col).text(col);
            if (column && column === col) {
                option.prop('selected', true);
            }
            columnSelect.append(option);
        });
        
        columnSelectCol.append(columnLabel, columnSelect);
        
        // Контейнер для значений
        const valuesCol = $('<div>').addClass('col-md-7 mb-2');
        const valuesContainer = $('<div>').addClass('filter-values-container');
        
        // Если колонка уже выбрана, показываем список значений
        if (column) {
            showFilterValues(valuesContainer, column, values);
        } else {
            valuesContainer.append($('<p>').addClass('text-muted').text('Сначала выберите колонку'));
        }
        
        valuesCol.append(valuesContainer);
        
        // Обработчик изменения колонки
        columnSelect.on('change', function() {
            const selectedColumn = $(this).val();
            valuesContainer.empty();
            
            if (selectedColumn) {
                showFilterValues(valuesContainer, selectedColumn);
            } else {
                valuesContainer.append($('<p>').addClass('text-muted').text('Сначала выберите колонку'));
            }
        });
        
        filterRow.append(columnSelectCol, valuesCol);
        filterItem.append(closeBtn, filterRow);
        
        $('#filtersContainer').append(filterItem);
    }
    
    // Функция для отображения списка значений для выбранной колонки
    function showFilterValues(container, column, selectedValues = null) {
        const label = $('<label>').addClass('form-label').text('Выберите значения');
        const valuesList = $('<div>').addClass('filter-value-list');
        
        // Создаем чекбоксы для каждого уникального значения
        if (uniqueValues[column] && uniqueValues[column].length > 0) {
            uniqueValues[column].forEach(value => {
                const formCheck = $('<div>').addClass('form-check');
                const checkbox = $('<input>')
                    .addClass('form-check-input filter-value-checkbox')
                    .attr('type', 'checkbox')
                    .attr('value', value)
                    .attr('id', `filter-${column}-${value}`);
                
                // Если есть выбранные значения, отмечаем соответствующие чекбоксы
                if (selectedValues && selectedValues.includes(value)) {
                    checkbox.prop('checked', true);
                }
                
                const checkLabel = $('<label>')
                    .addClass('form-check-label')
                    .attr('for', `filter-${column}-${value}`)
                    .text(value);
                
                formCheck.append(checkbox, checkLabel);
                valuesList.append(formCheck);
            });
        } else {
            valuesList.append($('<p>').addClass('text-muted').text('Нет данных для фильтрации'));
        }
        
        // Кнопки для выбора всех/снятия всех
        const selectBtns = $('<div>').addClass('d-flex gap-2 mt-2');
        const selectAllBtn = $('<button>').addClass('btn btn-outline-primary btn-sm').text('Выбрать все');
        const deselectAllBtn = $('<button>').addClass('btn btn-outline-secondary btn-sm').text('Снять все');
        
        selectAllBtn.on('click', function() {
            valuesList.find('input[type="checkbox"]').prop('checked', true);
        });
        
        deselectAllBtn.on('click', function() {
            valuesList.find('input[type="checkbox"]').prop('checked', false);
        });
        
        selectBtns.append(selectAllBtn, deselectAllBtn);
        
        container.append(label, valuesList, selectBtns);
    }
    
    // Добавление фильтра по кнопке
    $('#addFilterBtn').on('click', function() {
        addFilter();
    });
    
    // Очистка всех фильтров
    $('#clearAllFiltersBtn').on('click', function() {
        $('#filtersContainer').empty();
    });
    
    // Применение фильтров
    $('#applyFiltersBtn').on('click', function() {
        // Сначала удаляем старый индикатор
        $('.active-filters-indicator').remove();
        
        activeFilters = {};
        let hasActiveFilters = false;
        
        // Собираем все значения фильтров
        $('.filter-item').each(function() {
            const column = $(this).find('.filter-column-select').val();
            if (!column) return;
            
            const selectedValues = [];
            $(this).find('.filter-value-checkbox:checked').each(function() {
                selectedValues.push($(this).val());
            });
            
            if (selectedValues.length > 0) {
                activeFilters[column] = selectedValues;
                hasActiveFilters = true;
            }
        });
        
        console.log("Применяем фильтры:", activeFilters, "hasActiveFilters:", hasActiveFilters);
        
        // Если есть активные фильтры, показываем кнопку сброса и индикатор
        if (hasActiveFilters) {
            $('#resetFiltersBtn').removeClass('d-none');
            $('#showFiltersBtn').append(
                $('<span>').addClass('active-filters-indicator').text(Object.keys(activeFilters).length)
            );
        } else {
            $('#resetFiltersBtn').addClass('d-none');
        }
        
        // Перерисовываем таблицу с учетом фильтров
        renderTable();
    });
    
    // Сброс фильтров
    $('#resetFiltersBtn').on('click', function() {
        activeFilters = {};
        $(this).addClass('d-none');
        $('.active-filters-indicator').remove();
        renderTable();
    });
    
    // При открытии модального окна фильтров заполняем существующие фильтры
    $('#filtersModal').on('show.bs.modal', function() {
        $('#filtersContainer').empty();
        
        if (Object.keys(activeFilters).length > 0) {
            for (const [column, values] of Object.entries(activeFilters)) {
                addFilter(column, values);
            }
        } else {
            // Если нет активных фильтров, добавляем пустой фильтр
            addFilter();
        }
    });
});
</script>
{% endblock %} 